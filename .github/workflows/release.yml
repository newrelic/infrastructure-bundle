name: Container release
on:
  release:
    types: [ prereleased, released ]

jobs:
  container-release:
    uses: newrelic/coreint-automation/.github/workflows/reusable_image_release.yaml@NR-341876-Make-docker-images-pre-release-uniform
    with:
      original_repo_name: 'newrelic/infrastructure-bundle'
      docker_image_name: 'newrelic/infrastructure-bundle'
      docker_platforms: 'linux/amd64,linux/arm64'
      go_version_file: 'go.mod'
      
      run_nix_unit_tests: false
      run_windows_unit_tests: false
      run_integration_tests: false
      
      use_build_push_action: false
      use_custom_release: true

      release_command: |
        go run downloader.go
        ./docker-build.sh . --push
        if [ "$PRERELEASE" = "false" ]; then
          DOCKER_IMAGE_TAG=latest ./docker-build.sh . --push
        fi
    
    secrets:
      docker_username: ${{ secrets.OHAI_DOCKER_HUB_ID }}
      docker_password: ${{ secrets.OHAI_DOCKER_HUB_PASSWORD }}
